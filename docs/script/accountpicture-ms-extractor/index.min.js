/*MIT License Copyright (c) Anthony Beaumont*/const{Buffer:Buffer}=window.buffer;function indexOfAny(e,t,r=0){for(const n of t){const t=e.indexOf(n,r);if(t>-1)return{pos:t,length:n.length}}return{pos:-1,length:0}}function split(e,t,r={}){Buffer.isBuffer(t)&&(t=[t]);const n=r.includeSeparator||!1;let f=[],o=-1,s=0;for(;o++<e.length;){const r=indexOfAny(e,t,o);o=r.pos>=0?r.pos:e.length;const a=e.subarray(s,o);s=n?o:o+r.length,a.length>0&&f.push(a)}return f}const PNG={ext:"png",header:Buffer.from("89504E470D0A1A0A","hex"),trailer:Buffer.from("49454E44","hex"),trailerOffset:4},JPEG={ext:"jpeg",header:Buffer.from("FFD8FFE0","hex"),trailer:Buffer.from("FFD9","hex")};function base64(e,t){return`data:image/${t};charset=utf-8;base64,${e.toString("base64")}`}async function extract(e){if(!Buffer.isBuffer(e))throw"Expecting type Buffer";try{const t=await Promise.any([slice(e,...Object.values(PNG)),slice(e,...Object.values(JPEG))]);return{lowres:{buffer:t.lowres,format:t.format,base64:function(){return base64(this.buffer,this.format)}},highres:{buffer:t.highres,format:t.format,base64:function(){return base64(this.buffer,this.format)}}}}catch{throw"Unexpected file content: no PNG or JPEG to retrieve !"}}function slice(e,t,r,n,f=0){return new Promise((o,s)=>{const a=split(e,r,{includeSeparator:!0});if(3!==a.length)return s("Unexpected file content");const i=a[1].lastIndexOf(n),u=a[2].lastIndexOf(n);return-1===i||-1===u?s("Unexpected file content"):o({format:t,lowres:a[1].subarray(0,i+n.length+f),highres:a[2].subarray(0,u+n.length+f)})})}export{extract};